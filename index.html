<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Sohbet â€” GeliÅŸmiÅŸ (WebRTC + PeerJS)</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --border:#1f2937;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background:radial-gradient(1200px 600px at 70% -10%, rgba(34,197,94,.08), transparent) , linear-gradient(180deg,#0b1220,#0f172a 60%, #0b1220); color:var(--text)}
    .wrap{ max-width:1000px; margin:24px auto; padding:16px }
    .card{ background:rgba(17,24,39,.75); backdrop-filter: blur(8px); border:1px solid var(--border); border-radius:18px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    header{ padding:16px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border) }
    h1{ margin:0; font-size:20px; letter-spacing:.2px }
    .muted{ color:var(--muted) }

    .grid{ display:grid; gap:12px }
    .controls{ padding:16px; display:grid; gap:12px; grid-template-columns: 1.2fr 1fr auto auto; align-items:end }
    @media (max-width: 860px){ .controls{ grid-template-columns: 1fr 1fr } }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px }
    input[type=text], input[type=url], input[type=number], textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--text); outline:none }
    input:focus, textarea:focus{ border-color:#334155; box-shadow:0 0 0 3px rgba(51,65,85,.35) }

    button{ border:0; padding:10px 14px; border-radius:10px; background:var(--accent); color:#062c16; cursor:pointer; font-weight:700 }
    button.secondary{ background:#1f2937; color:#cbd5e1 }
    button.ghost{ background:transparent; border:1px solid #334155; color:#cbd5e1 }
    button:disabled{ opacity:.55; cursor:not-allowed }

    details{ background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:8px 12px }
    summary{ cursor:pointer; color:#cbd5e1; font-weight:600; padding:6px 0 }

    .chat{ padding:0 16px 16px; display:grid; grid-template-rows: minmax(420px, 62vh) auto; gap:12px }
    .messages{ background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px; overflow:auto; scroll-behavior:smooth }
    .msg{ margin:10px 0; display:flex; gap:10px; align-items:flex-start }
    .bubble{ max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.35; word-wrap:break-word; white-space:pre-wrap; }
    .mine .bubble{ background:#163427; border:1px solid #1e3a2f }
    .theirs .bubble{ background:#101827; border:1px solid #2b3647 }
    .meta{ font-size:11px; color:#93a3b5; margin-bottom:4px }
    .system .bubble{ background:#111827; border:1px dashed #334155; font-style:italic; opacity:.9 }

    .composer{ display:grid; grid-template-columns: 1fr auto; gap:10px }
    textarea{ resize:none; height:52px }

    .foot{ padding:12px 16px; font-size:12px; color:#94a3b8; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220 }
    .dot{ width:8px; height:8px; border-radius:99px; background:var(--danger) }
    .dot.ok{ background:var(--accent) }
    .small{ font-size:11px; color:#9ca3af }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .kpi{ display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap:8px }
    .kpi .tile{ background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:10px 12px }
    .tile h4{ margin:0; font-size:12px; color:#93a3b5 }
    .tile .v{ margin-top:6px; font-weight:700 }
    code.inline{ background:#0b1220; border:1px solid #334155; padding:2px 6px; border-radius:6px }
    .pill{ padding:4px 8px; border:1px solid #334155; border-radius:20px; font-size:11px }
    .typing{ font-size:12px; color:#cbd5e1; opacity:.8 }
  </style>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>ðŸ”— P2P Sohbet <span class="muted">(WebRTC â€¢ Sohbet KimliÄŸi)</span></h1>
        <div class="row">
          <span class="pill" id="httpsWarn" hidden>HTTPS gerekli olabilir</span>
          <span class="muted" id="status">HazÄ±râ€¦</span>
        </div>
      </header>

      <div class="controls">
        <div>
          <label for="room">Sohbet KimliÄŸi</label>
          <input id="room" type="text" placeholder="Ã¶r. fen8a-sinif" autocomplete="off" />
        </div>
        <div>
          <label for="nick">Takma Ad</label>
          <input id="nick" type="text" placeholder="Ã¶r. ugur" autocomplete="nickname" />
        </div>
        <div class="row">
          <button id="hostBtn" class="secondary" title="OdayÄ± kur (diÄŸerleri sana baÄŸlanÄ±r)">Sunucu (Host) Ol</button>
          <button id="joinBtn" class="secondary" title="Mevcut odaya baÄŸlan">KatÄ±l</button>
        </div>
        <div class="row">
          <button id="copyLink" class="ghost">BaÄŸlantÄ±yÄ± Kopyala</button>
          <button id="leaveBtn" class="ghost" disabled>Odadan AyrÄ±l</button>
        </div>
      </div>

      <div class="grid" style="padding:0 16px 12px">
        <details>
          <summary>ðŸ”§ GeliÅŸmiÅŸ Ayarlar (Sinyal & ICE)</summary>
          <div class="grid" style="margin-top:8px; grid-template-columns: repeat(6, 1fr); gap:10px">
            <div style="grid-column: span 2">
              <label>Peer Host</label>
              <input id="cfgHost" type="text" placeholder="0.peerjs.com" />
            </div>
            <div>
              <label>Port</label>
              <input id="cfgPort" type="number" placeholder="443" />
            </div>
            <div>
              <label>Path</label>
              <input id="cfgPath" type="text" placeholder="/" />
            </div>
            <div>
              <label>Secure (HTTPS)</label>
              <input id="cfgSecure" type="text" placeholder="true" />
            </div>
            <div style="grid-column: 1 / -1">
              <label>ICE Servers (JSON)</label>
              <textarea id="cfgIce" rows="3" placeholder='[{"urls":"stun:stun.l.google.com:19302"}]'></textarea>
            </div>
            <div class="row" style="grid-column: 1 / -1; justify-content: flex-end">
              <button id="cfgReset" class="ghost">VarsayÄ±lanlarÄ± YÃ¼kle</button>
              <button id="cfgApply" class="ghost">AyarlarÄ± Kullan</button>
            </div>
          </div>
        </details>
      </div>

      <div class="grid" style="padding:0 16px 10px">
        <div class="kpi">
          <div class="tile"><h4>Durum</h4><div class="v" id="kDurum">Bekliyor</div></div>
          <div class="tile"><h4>BaÄŸlÄ± KiÅŸi</h4><div class="v" id="kPeers">0</div></div>
          <div class="tile"><h4>ICE</h4><div class="v" id="kIce">â€”</div></div>
          <div class="tile"><h4>RTT (ms)</h4><div class="v" id="kRtt">â€”</div></div>
        </div>
      </div>

      <div class="chat">
        <div id="messages" class="messages" aria-live="polite"></div>
        <div class="composer">
          <textarea id="input" placeholder="Mesaj yazâ€¦" disabled></textarea>
          <div class="grid" style="grid-template-columns:auto auto; gap:8px">
            <button id="sendBtn" disabled>GÃ¶nder</button>
            <button id="pingBtn" class="ghost" disabled>Ping</button>
          </div>
        </div>
        <div class="typing" id="typing" style="padding:0 4px" hidden>Birisi yazÄ±yorâ€¦</div>
      </div>

      <div class="foot">
        <div class="badge"><span class="dot" id="connDot"></span><span id="connText">BaÄŸlantÄ± yok</span></div>
        <div>
          <span class="small">WebRTC veri kanalÄ± (DTLS). En iyi sonuÃ§ iÃ§in kendi PeerJS/TURN sunucunla kullan.</span>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const qs = (s) => document.querySelector(s);
  const $room = qs('#room');
  const $nick = qs('#nick');
  const $messages = qs('#messages');
  const $input = qs('#input');
  const $send = qs('#sendBtn');
  const $ping = qs('#pingBtn');
  const $host = qs('#hostBtn');
  const $join = qs('#joinBtn');
  const $copy = qs('#copyLink');
  const $leave = qs('#leaveBtn');
  const $status = qs('#status');
  const $dot = qs('#connDot');
  const $connText = qs('#connText');
  const $kDurum = qs('#kDurum');
  const $kPeers = qs('#kPeers');
  const $kIce = qs('#kIce');
  const $kRtt = qs('#kRtt');
  const $typing = qs('#typing');
  const $httpsWarn = qs('#httpsWarn');

  // Advanced config inputs
  const $cfgHost = qs('#cfgHost');
  const $cfgPort = qs('#cfgPort');
  const $cfgPath = qs('#cfgPath');
  const $cfgSecure = qs('#cfgSecure');
  const $cfgIce = qs('#cfgIce');
  const $cfgApply = qs('#cfgApply');
  const $cfgReset = qs('#cfgReset');

  // State
  let peer = null;              // local PeerJS instance
  let isHost = false;           // am I the host?
  const conns = new Map();      // id -> DataConnection (host only)
  let conn = null;              // single connection when joining
  let typingTimer = null;       // typing indicator
  let lastPingSent = 0;

  const defaultCfg = () => ({
    host: '0.peerjs.com', port: 443, path: '/', secure: true,
    config: { iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }
      // TURN Ã¶rneÄŸi: { urls:'turn:turn.yourserver.com:3478', username:'user', credential:'pass' }
    ]}
  });

  function loadCfg(){
    let cfg = null;
    try{ cfg = JSON.parse(localStorage.getItem('p2p_cfg')||'null'); }catch{}
    if (!cfg) cfg = defaultCfg();
    $cfgHost.value = cfg.host ?? '0.peerjs.com';
    $cfgPort.value = cfg.port ?? 443;
    $cfgPath.value = cfg.path ?? '/';
    $cfgSecure.value = String(cfg.secure ?? true);
    try{ $cfgIce.value = JSON.stringify(cfg.config?.iceServers || [], null, 2); }catch{ $cfgIce.value = '[]'; }
    return cfg;
  }
  function saveCfg(){
    const cfg = {
      host: $cfgHost.value || '0.peerjs.com',
      port: Number($cfgPort.value || 443),
      path: $cfgPath.value || '/',
      secure: ($cfgSecure.value||'true').toLowerCase() !== 'false',
      config: { iceServers: [] }
    };
    try{ cfg.config.iceServers = JSON.parse($cfgIce.value||'[]'); }catch{ alert('ICE JSON biÃ§imi hatalÄ±'); }
    localStorage.setItem('p2p_cfg', JSON.stringify(cfg));
    return cfg;
  }
  function applyCfg(){ return saveCfg(); }

  $cfgReset?.addEventListener('click', () => { localStorage.removeItem('p2p_cfg'); loadCfg(); setStatus('VarsayÄ±lan ayarlar yÃ¼klendi'); });
  $cfgApply?.addEventListener('click', () => { applyCfg(); setStatus('Ayarlar kaydedildi'); });

  // URL param/fragment hydration
  try {
    const u = new URL(location.href);
    const rid = u.searchParams.get('room') || u.hash.replace('#','');
    if (rid) $room.value = rid;
    const nk = u.searchParams.get('nick');
    if (nk) $nick.value = nk;
  } catch {}
  // load saved nick/cfg
  try { const n = localStorage.getItem('p2p_nick'); if (n) $nick.value = n; } catch{}
  const cfgInit = loadCfg();

  // HTTPS hint
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    $httpsWarn.hidden = false;
  }

  function logLine(html, cls='theirs'){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + cls;
    wrap.innerHTML = `<div class="bubble">${html}</div>`;
    $messages.appendChild(wrap);
    $messages.scrollTop = $messages.scrollHeight;
  }
  function addMsg(author, text, mine=false){
    const row = document.createElement('div');
    row.className = 'msg ' + (mine ? 'mine' : 'theirs');
    const meta = `<div class="meta">${escapeHtml(author)} â€¢ ${new Date().toLocaleTimeString()}</div>`;
    row.innerHTML = `<div>${meta}<div class="bubble">${escapeHtml(text)}</div></div>`;
    $messages.appendChild(row);
    $messages.scrollTop = $messages.scrollHeight;
  }
  function addSystem(text){
    const row = document.createElement('div');
    row.className = 'msg system';
    const meta = `<div class="meta">Sistem â€¢ ${new Date().toLocaleTimeString()}</div>`;
    row.innerHTML = `<div>${meta}<div class="bubble">${escapeHtml(text)}</div></div>`;
    $messages.appendChild(row);
    $messages.scrollTop = $messages.scrollHeight;
  }
  function setStatus(t){ $status.textContent = t; $kDurum.textContent = t; }
  function setConn(ok, txt){ $dot.classList.toggle('ok', !!ok); $connText.textContent = txt || (ok ? 'BaÄŸlÄ±' : 'BaÄŸlantÄ± yok'); }
  function enableChat(on){ $input.disabled = !on; $send.disabled = !on; $ping.disabled = !on; $leave.disabled = on ? false : true; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function broadcast(packet, exceptId){
    for(const [id,c] of conns){ if (id === exceptId) continue; try { c.open && c.send(packet); } catch {} }
  }

  function peerInit(idOrUndefined, cfg){
    try { if (peer) peer.destroy(); } catch {}
    const p = new Peer(idOrUndefined, cfg);
    p.on('error', e => { setStatus('Hata: ' + e.type); console.error(e); alert('Peer hata: ' + e); });
    return p;
  }

  function setupHost(){
    const roomId = ($room.value||'').trim();
    const nick = ($nick.value||'').trim() || 'host';
    if (!roomId) return alert('Bir Sohbet KimliÄŸi gir.');
    isHost = true;
    setStatus('Sohbet kuruluyor (host)â€¦');
    localStorage.setItem('p2p_nick', nick);

    const cfg = loadCfg();
    peer = peerInit(roomId, cfg);

    peer.on('open', id => {
      setStatus(`Oda hazÄ±r: ${id}`);
      setConn(true, 'KatÄ±lÄ±mlar bekleniyorâ€¦');
      logLine(`<b>Oda aÃ§Ä±ldÄ±:</b> <code class="inline">${id}</code>. KatÄ±lÄ±mcÄ±lar bu kimlikle baÄŸlanabilir.`);
      enableChat(true);
      addSystem(`${nick} odayÄ± aÃ§tÄ±`);
      updateKpi();
    });

    peer.on('connection', c => {
      conns.set(c.peer, c);
      $kPeers.textContent = String(conns.size);
      setConn(true, `${conns.size} kiÅŸi baÄŸlÄ±`);

      c.on('data', d => onDataFrom(c, d));
      c.on('iceStateChanged', s => { $kIce.textContent = s; });
      c.on('close', () => {
        conns.delete(c.peer);
        $kPeers.textContent = String(conns.size);
        setConn(conns.size>0, `${conns.size} kiÅŸi baÄŸlÄ±`);
        broadcast({type:'system', t:`Bir katÄ±lÄ±mcÄ± ayrÄ±ldÄ±`});
      });
      c.on('error', (e) => console.warn('conn error', e));
    });
  }

  function setupJoin(){
    const roomId = ($room.value||'').trim();
    const nick = ($nick.value||'').trim() || ('kullanici-' + Math.floor(Math.random()*999));
    if (!roomId) return alert('Bir Sohbet KimliÄŸi gir.');

    isHost = false;
    setStatus('Odaya baÄŸlanÄ±lÄ±yorâ€¦');
    localStorage.setItem('p2p_nick', nick);

    const cfg = loadCfg();
    peer = peerInit(undefined, cfg);

    peer.on('open', id => {
      conn = peer.connect(roomId, { reliable:true });
      bindJoinConn(conn, nick);
    });
  }

  function bindJoinConn(c, nick){
    c.on('open', () => {
      setStatus(`BaÄŸlÄ±: ${c.peer}`);
      setConn(true, 'BaÄŸlÄ±');
      enableChat(true);
      c.send({type:'join', n:nick});
      updateKpi();
    });
    c.on('data', d => onDataFrom(c, d));
    c.on('iceStateChanged', s => { $kIce.textContent = s; });
    c.on('close', () => { setConn(false,'BaÄŸlantÄ± yok'); enableChat(false); addSystem('BaÄŸlantÄ± kapandÄ±'); });
    c.on('error', e => { console.error(e); alert('BaÄŸlantÄ± hatasÄ±: '+e); });
  }

  function onDataFrom(c, d){
    if (!d || typeof d !== 'object') return;
    if (d.type === 'msg') addMsg(d.n, d.t, false);
    if (d.type === 'system') addSystem(d.t);
    if (d.type === 'join') {
      addSystem(`${d.n} katÄ±ldÄ±`);
      broadcast({type:'system', t:`${d.n} katÄ±ldÄ±`}, c.peer);
    }
    if (d.type === 'typing') {
      showTyping();
      if (isHost) broadcast(d, c.peer);
    }
    if (d.type === 'ping') { // echo to measure RTT
      const now = performance.now();
      const rtt = Math.round(now - d.ts);
      $kRtt.textContent = String(rtt);
      if (isHost) broadcast(d, c.peer);
    }
  }

  function sendCurrent(){
    const text = ($input.value||'').trim();
    if (!text) return;
    const nick = ($nick.value||'').trim() || (isHost ? 'host' : 'ben');
    addMsg(nick, text, true);

    const pkt = { type:'msg', n: nick, t: text };
    if (isHost){
      broadcast(pkt);
    } else if (conn && conn.open){
      conn.send(pkt);
    }
    $input.value = '';
    $input.focus();
  }

  function leaveRoom(){
    try {
      if (isHost){ for(const [,c] of conns){ try{ c.close(); }catch{} } conns.clear(); }
      else if (conn) { try{ conn.close(); }catch{} }
      if (peer) { try{ peer.destroy(); }catch{} }
    } finally { enableChat(false); setConn(false, 'BaÄŸlantÄ± yok'); setStatus('AyrÄ±ldÄ±n'); $kPeers.textContent = '0'; $kIce.textContent = 'â€”'; $kRtt.textContent = 'â€”'; }
  }

  function copyLink(){
    const r = ($room.value||'').trim(); if (!r) return alert('Kimlik gir.');
    const u = new URL(location.href);
    u.searchParams.set('room', r);
    const nk = ($nick.value||'').trim(); if (nk) u.searchParams.set('nick', nk);
    navigator.clipboard.writeText(u.toString()).then(()=>{ setStatus('BaÄŸlantÄ± kopyalandÄ±'); });
  }

  function showTyping(){
    $typing.hidden = false; clearTimeout(typingTimer);
    typingTimer = setTimeout(()=>{ $typing.hidden = true; }, 1200);
  }

  function sendTyping(){
    const pkt = { type:'typing' };
    if (isHost) broadcast(pkt);
    else if (conn && conn.open) conn.send(pkt);
  }

  function ping(){
    const pkt = { type:'ping', ts: performance.now() };
    lastPingSent = pkt.ts;
    if (isHost) broadcast(pkt);
    else if (conn && conn.open) conn.send(pkt);
  }

  function updateKpi(){
    try{
      const pcs = (peer?._connections) ? Object.values(peer._connections).flat() : [];
      // PeerJS private internals; may not exist across versions
      $kPeers.textContent = isHost ? String(conns.size) : (conn && conn.open ? '1' : '0');
    }catch{}
  }

  $send.addEventListener('click', sendCurrent);
  $ping.addEventListener('click', ping);
  $input.addEventListener('input', sendTyping);
  $input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendCurrent(); } });
  $host.addEventListener('click', setupHost);
  $join.addEventListener('click', setupJoin);
  $leave.addEventListener('click', leaveRoom);
  $copy.addEventListener('click', copyLink);

})();
</script>
</body>
</html>
